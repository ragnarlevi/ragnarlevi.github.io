<html>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Ragnar - Hidden Markov Models </title><meta content="Model,Classification" name=keywords>
<meta content="Ragnar - In this notebook I will be exploring a Hidden Markov Model (HMM) to classify bull and bear states of a simulated financial instrument.
library(depmixS4) library(ggplot2) library(matrixStats) Simulate the data. Assume returns are normally distributed. Where the mean and the standard deviation depends on the state of the financial market. We will only consider 2 states.
set.seed(42)  Nk_lower <- 50 Nk_upper <- 150 bull_mean <- 0.1 bull_var <- 0.1 bear_mean <- -0." name=description>
<meta name=viewport content="width=device-width,initial-scale=1">
<script type=text/x-mathjax-config>
        MathJax.Hub.Config({
            extensions: ["tex2jax.js"],
            jax: ["input/TeX", "output/HTML-CSS"],
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                processEscapes: true
            },
            "HTML-CSS": { availableFonts: ["TeX"] }
        });
    </script>
<script src=https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin=anonymous></script>
<link rel=stylesheet href=/layui/css/layui.css>
<link rel=stylesheet href=/self/css/default.css>
<script src=/layui/layui.js></script>
<link rel=stylesheet async href=/self/css/markdown.min.css>
<link rel=stylesheet async href=/self/css/gallery.css>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous>
<script async src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js integrity="sha256-h2tMEmhemR2IN4wbbdNjj9LaDIjzwk2hralQwfJmBOE=" crossorigin=anonymous></script></head><body>
<header class="layui-header layui-bg-cyan">
<a class=nav-self-logo href=/>
Ragnar
</a>
<ul class="layui-nav layui-layout-right layui-bg-cyan" lay-filter>
<li class=layui-nav-item id=nav_big><a href=/post/>Posts</a></li><li class=layui-nav-item id=nav_big><a href=/about/>About</a></li><li class=layui-nav-item id=nav_small>
<a href=javascript:;>
<i class="layui-icon layui-icon-app" style=font-size:24px></i>
</a>
<dl class=layui-nav-child>
<dd><a href=/post/>Posts</a></dd><dd><a href=/about/>About</a></dd></dl></li></ul></header><script>layui.use("element",function(){var e=layui.element})</script>
<div id=content style=min-height:80%>
<div class=layui-container style=margin-bottom:10px>
<div class="layui-row layui-col-space10">
<div class="layui-col-md8 layui-col-sm12 layui-col-xs12">
<div class="layui-card single-card">
<br>
<blockquote class="self-elem-quote self-elem-quote-bg-red markdown-body single-title">
<h1>Hidden Markov Models</h1><h3 style=margin-top:10px;margin-bottom:10px>
<i class="layui-icon layui-icon-date" style=font-size:28px;vertical-align:-2px></i>
<span>2022-02-15</span>
<i class="layui-icon layui-icon-tabs" style=font-size:22px;vertical-align:1px;margin-right:2px></i>
<a href=/tags/model/>
<span class="layui-badge layui-bg-orange" style=vertical-align:2px>Model</span>
</a>
<a href=/tags/classification/>
<span class="layui-badge layui-bg-orange" style=vertical-align:2px>Classification</span>
</a>
</h3></blockquote><div class="layui-card-body markdown-body single-content">
<p>In this notebook I will be exploring a Hidden Markov Model (HMM) to
classify bull and bear states of a simulated financial instrument.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>library</span>(depmixS4)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(ggplot2)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(matrixStats)
</span></span></code></pre></div><p>Simulate the data. Assume returns are normally distributed. Where the
mean and the standard deviation depends on the state of the financial
market. We will only consider 2 states.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>set.seed</span>(<span style=color:#ae81ff>42</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Nk_lower <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>Nk_upper <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>150</span>
</span></span><span style=display:flex><span>bull_mean <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>0.1</span>
</span></span><span style=display:flex><span>bull_var <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>0.1</span>
</span></span><span style=display:flex><span>bear_mean <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>-0.05</span>
</span></span><span style=display:flex><span>bear_var <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>0.2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create the list of durations (in days) for each regime</span>
</span></span><span style=display:flex><span>days <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>replicate</span>(<span style=color:#ae81ff>5</span>, <span style=color:#a6e22e>sample</span>(Nk_lower<span style=color:#f92672>:</span>Nk_upper, <span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create the various bull and bear markets returns</span>
</span></span><span style=display:flex><span>market_bull_1 <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rnorm</span>( days[1], bull_mean, bull_var)
</span></span><span style=display:flex><span>market_bear_2 <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rnorm</span>( days[2], bear_mean, bear_var)
</span></span><span style=display:flex><span>market_bull_3 <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rnorm</span>( days[3], bull_mean, bull_var)
</span></span><span style=display:flex><span>market_bear_4 <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rnorm</span>( days[4], bear_mean, bear_var)
</span></span><span style=display:flex><span>market_bull_5 <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rnorm</span>( days[5], bull_mean, bull_var)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create the list of true regime states and full returns list</span>
</span></span><span style=display:flex><span>true_regimes <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>( <span style=color:#a6e22e>rep</span>(<span style=color:#ae81ff>1</span>,days[1]), <span style=color:#a6e22e>rep</span>(<span style=color:#ae81ff>2</span>,days[2]), <span style=color:#a6e22e>rep</span>(<span style=color:#ae81ff>1</span>,days[3]), <span style=color:#a6e22e>rep</span>(<span style=color:#ae81ff>2</span>,days[4]), <span style=color:#a6e22e>rep</span>(<span style=color:#ae81ff>1</span>,days[5]))
</span></span><span style=display:flex><span>returns <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>( market_bull_1, market_bear_2, market_bull_3, market_bear_4, market_bull_5)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plot</span>(returns, type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;l&#34;</span>, xlab<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>, ylab<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Returns&#34;</span>)
</span></span></code></pre></div><p><img src=unnamed-chunk-2-1.png alt></p><p>By visual inspection we can clearly see when the instrument is in a good
and bad shape. We will start by using the package <code>depmixS4</code> to find the
hidden states. Afterwards we will try to replicate the results with our
own code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>hmm <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>depmix</span>(returns <span style=color:#f92672>~</span> <span style=color:#ae81ff>1</span>, family <span style=color:#f92672>=</span> <span style=color:#a6e22e>gaussian</span>(), nstates <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>, data<span style=color:#f92672>=</span><span style=color:#a6e22e>data.frame</span>(returns<span style=color:#f92672>=</span>returns))
</span></span><span style=display:flex><span>hmmfit <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>fit</span>(hmm, verbose <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>)
</span></span></code></pre></div><pre><code>## converged at iteration 20 with logLik: 299.9928
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># Output both the true regimes and the</span>
</span></span><span style=display:flex><span><span style=color:#75715e># posterior probabilities of the regimes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>post_probs <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>posterior</span>(hmmfit, type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;viterbi&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>layout</span>(<span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>plot</span>(post_probs<span style=color:#f92672>$</span>state, type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;s&#39;</span>, main<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;True Regimes&#39;</span>, xlab<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>, ylab<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Regime&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>matplot</span>(post_probs[,<span style=color:#ae81ff>-1</span>], type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;l&#39;</span>, main<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Regime Posterior Probabilities&#39;</span>, ylab<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Probability&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>legend</span>(x<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;topright&#39;</span>, <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#39;Bull&#39;</span>,<span style=color:#e6db74>&#39;Bear&#39;</span>), fill<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>2</span>, bty<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;n&#39;</span>)
</span></span></code></pre></div><p><img src=unnamed-chunk-4-1.png alt></p><p>The model does a good job. Now we will go through the maths of a HMM
model. Let $x_t$ denote the observed state aka the stock return and let $z_t$ denote the hidden state governing the dynamics of $x_t$. The forward filter algorithm allows us to compute the filtered
marginals $p(z_t | x_{1:t})$
. Note that we can write:</p><p>\begin{equation}
\begin{split}
p(z_t = j | x_{1:t}) = p(z_t = j | x_t, x_{1:t-1}) = \frac{p(x_t | z_t = j) p(z_t = j | x_{1:t-1})}{p(x_t | x_{1:t-1})}
\end{split}
\end{equation}</p><p>where we used the fact that $x_t$ does not depend on $x_{1:t-1}$. Using this we can calculate $p(z_t = j | x_{1:t})$ recursively. Denote $\boldsymbol{\alpha}<em>t = [p(z_t = 1 | x</em>{1:t}),\dots, p(z_t = K | x_{1:t})]^T$ and $\boldsymbol{Z}$ the transition matrix were $Z_ij$ denotes jump from $i$ to $j$
.
$$\boldsymbol{\alpha}<em>t\propto\phi_t\odot (\boldsymbol{Z}^T\boldsymbol{\alpha}</em>{t-1}) $$
where $\boldsymbol{\phi}<em>t = [p(x_t | z_t = 1),\dots, p(x_t | z_t = K)]^T$ is a vector and $\boldsymbol{Z}$ is the transition matrix with entries $Z</em>{ij} = p(z_t =j | z_t = i)$</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>forward <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>function</span>(init_a, Z, phi, x){
</span></span><span style=display:flex><span>  <span style=color:#75715e># init_a - initial distribution p(z_1 = j)</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Z - transition matrix</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># phi list of probability densities p(x_t | z_t = j)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  normalization_const <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rep</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>length</span>(x))
</span></span><span style=display:flex><span>  a <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>matrix</span>(<span style=color:#ae81ff>0</span>, ncol <span style=color:#f92672>=</span> <span style=color:#a6e22e>length</span>(x), nrow <span style=color:#f92672>=</span> <span style=color:#a6e22e>length</span>(init_a))
</span></span><span style=display:flex><span>  phi_vec <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sapply</span>(phi, <span style=color:#a6e22e>function</span>(f, x){ <span style=color:#a6e22e>f</span>(x)}, x <span style=color:#f92672>=</span> x[1])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  a[, <span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;-</span> phi_vec<span style=color:#f92672>*</span>init_a
</span></span><span style=display:flex><span>  normalization_const[1] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sum</span>(a[,<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>  a[, <span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;-</span> a[, <span style=color:#ae81ff>1</span>]<span style=color:#f92672>/</span><span style=color:#a6e22e>sum</span>(a[,<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>  a<span style=color:#a6e22e>[is.nan</span>(a[, <span style=color:#ae81ff>1</span>]), <span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>for</span>(i in <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span><span style=color:#a6e22e>length</span>(x)){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    phi_vec <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sapply</span>(phi, <span style=color:#a6e22e>function</span>(f, x){ <span style=color:#a6e22e>f</span>(x)}, x <span style=color:#f92672>=</span> x[i])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    a[,i] <span style=color:#f92672>&lt;-</span>  phi_vec <span style=color:#f92672>*</span> (<span style=color:#a6e22e>t</span>(Z) <span style=color:#f92672>%*%</span> a[,i<span style=color:#ae81ff>-1</span>])
</span></span><span style=display:flex><span>    normalization_const[i] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sum</span>(a[,i])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    a[, i] <span style=color:#f92672>&lt;-</span> a[, i]<span style=color:#f92672>/</span><span style=color:#a6e22e>sum</span>(a[,i])
</span></span><span style=display:flex><span>    a<span style=color:#a6e22e>[is.nan</span>(a[,i]), i] <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>return</span>(<span style=color:#a6e22e>list</span>(a <span style=color:#f92672>=</span> <span style=color:#a6e22e>as.data.frame</span>(<span style=color:#a6e22e>t</span>(a)), evidence <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>log</span>(normalization_const))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Let’s test the filter on the data using the fitted parameters of hmmfit
(using hmmfit).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>f_x1 <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>function</span>(x){<span style=color:#a6e22e>dnorm</span>(x, mean <span style=color:#f92672>=</span> <span style=color:#a6e22e>getpars</span>(hmmfit)[7], sd <span style=color:#f92672>=</span> <span style=color:#a6e22e>getpars</span>(hmmfit)[8])}
</span></span><span style=display:flex><span>f_x2 <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>function</span>(x){<span style=color:#a6e22e>dnorm</span>(x, mean <span style=color:#f92672>=</span> <span style=color:#a6e22e>getpars</span>(hmmfit)[9], sd <span style=color:#f92672>=</span> <span style=color:#a6e22e>getpars</span>(hmmfit)[10])}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>phi <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>list</span>(f_x1,f_x2)
</span></span><span style=display:flex><span>Z <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>matrix</span>(<span style=color:#a6e22e>getpars</span>(hmmfit)[3<span style=color:#f92672>:</span><span style=color:#ae81ff>6</span>], ncol <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>, byrow <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>)
</span></span><span style=display:flex><span>init_a <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>filter_out <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>forward</span>(init_a, Z, phi, returns)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>filter_out<span style=color:#f92672>$</span>a<span style=color:#f92672>$</span>days <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#a6e22e>length</span>(returns)
</span></span><span style=display:flex><span>filter_out<span style=color:#f92672>$</span>a<span style=color:#f92672>$</span>state <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>factor</span>(<span style=color:#a6e22e>ifelse</span>(filter_out<span style=color:#f92672>$</span>a<span style=color:#f92672>$</span>V1 <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0.5</span>, <span style=color:#e6db74>&#34;Bull&#34;</span>, <span style=color:#e6db74>&#34;Bear&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ggplot</span>(filter_out<span style=color:#f92672>$</span>a) <span style=color:#f92672>+</span> <span style=color:#a6e22e>geom_line</span>(<span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> days, y <span style=color:#f92672>=</span> V1, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Bear&#34;</span>)) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_line</span>(<span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> days, y <span style=color:#f92672>=</span> V2, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Bull&#34;</span>))<span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>theme_minimal</span>() <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>scale_color_manual</span>(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;State&#39;</span>,
</span></span><span style=display:flex><span>                     breaks<span style=color:#f92672>=</span><span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#39;Bear&#39;</span>, <span style=color:#e6db74>&#39;Bull&#39;</span>),
</span></span><span style=display:flex><span>                     values<span style=color:#f92672>=</span><span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#39;Bear&#39;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;red&#39;</span>, <span style=color:#e6db74>&#39;Bull&#39;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;darkgreen&#39;</span>))
</span></span></code></pre></div><p><img src=unnamed-chunk-6-1.png alt></p><p>The graph looks good, but it is a bit wiggly. We can produce smoother
lines if we allow for a non-online estimation, that is if we estimate
the state using all of our data, $p(z_t = j| x_{1:T})$
. This is simply called smoothing. We can write
$$p(z_t = j| x_{1:T})\propto p(z_t = j| x_{1:t})p(x_{t+1:T}| z_t = j)$$
Define $\boldsymbol{\beta}<em>t = [p(x</em>{t+1:T}| z_t = 1),\dots, p(x_{t+1:T}| z_t = K)]^T$
then we have
$$p(z_t = j| x_{1:T})\propto\alpha_t(j)\beta_t(j)$$
We can calculate $\beta_t(j)$
recursively as follows:</p><p>$$
\begin{equation}
\begin{split}
\beta_{t-1}(j) &= p(x_{t:T}| z_{t-1} = j ) \\\
&= \sum_i p(x_{t+1:T}, x_t, z_t = i| z_{t-1} = j ) \\\<br>
&= \sum_i p(x_{t+1:T} ,| z_t = i) p(x_t | z_t = i) p( z_t = i| z_{t-1} = j )
\end{split}
\end{equation}
$$</p><p>We can write this in a matrix form
$$\boldsymbol{\beta_{t-1}} =\boldsymbol{Z} (\boldsymbol{\phi}_t\odot\boldsymbol{\beta}_t) $$
The smoother starts by calculating $\boldsymbol{\alpha}_t$ using the (forward) filter, we already discussed, and then uses the
(backwards) recursion to calculate $\boldsymbol{\beta}_t$
just described, hence the name of this algorithm is the
forward-backwards algorithm. We will additionally calculate the smoothed
transitions as we will need it later.</p><p>$$
\begin{equation}
\begin{split}
p(z_t = i, z_{t+1} = j | x_{1:T}) &\propto p(z_t | x_{1:t})p(z_{t+1} |z_t, x_{t+1:T}) \\\
&\propto p(z_t | x_{1:t})p(x_{t+1:T} | z_{t+1}, z_t)p(z_{t+1}| z_t) \\\
&\propto p(z_t | x_{1:t})p(x_{t+1} | z_{t+1})p(x_{t+2:T}|z_{t+1})p(z_{t+1}| z_t) \\\
&\propto p(z_t | x_{1:t})p(x_{t+1} | z_{t+1})p(x_{t+2:T}|z_{t+1})p(z_{t+1}| z_t) \\\
&= \alpha_t(i) \phi_{t+1}(j)\beta_{t+1}(j) Z_{ij}
\end{split}
\end{equation}
$$</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>ForwardBackward <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>function</span>(init_a, Z, phi, x){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  T <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>length</span>(x)
</span></span><span style=display:flex><span>  K <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>length</span>(init_a)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  filter_out <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>forward</span>(init_a, Z, phi, returns)
</span></span><span style=display:flex><span>  a <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>t</span>(<span style=color:#a6e22e>as.matrix</span>(filter_out<span style=color:#f92672>$</span>a))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  b <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>matrix</span>(<span style=color:#ae81ff>0</span>, ncol <span style=color:#f92672>=</span> <span style=color:#a6e22e>length</span>(x), nrow <span style=color:#f92672>=</span> K)
</span></span><span style=display:flex><span>  O <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>array</span>(<span style=color:#ae81ff>1</span>, dim<span style=color:#f92672>=</span><span style=color:#a6e22e>c</span>(T<span style=color:#ae81ff>-1</span>,K,K))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  posterior <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>matrix</span>(<span style=color:#ae81ff>0</span>, ncol <span style=color:#f92672>=</span> <span style=color:#a6e22e>length</span>(x), nrow <span style=color:#f92672>=</span> K)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  phi_vec <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sapply</span>(phi, <span style=color:#a6e22e>function</span>(f, x){ <span style=color:#a6e22e>f</span>(x)}, x <span style=color:#f92672>=</span> x[T])
</span></span><span style=display:flex><span>  b[,T] <span style=color:#f92672>&lt;-</span> (Z <span style=color:#f92672>%*%</span> phi_vec)
</span></span><span style=display:flex><span>  posterior[,T] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>pmax</span>(b[,T], <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>1e-15</span>,<span style=color:#ae81ff>1e-15</span>))
</span></span><span style=display:flex><span>  posterior[,T] <span style=color:#f92672>&lt;-</span> posterior[,T]<span style=color:#f92672>/</span><span style=color:#a6e22e>sum</span>(posterior[,T])
</span></span><span style=display:flex><span>  posterior<span style=color:#a6e22e>[is.nan</span>(posterior[, T]), T] <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>for</span>(t in T<span style=color:#f92672>:</span><span style=color:#ae81ff>2</span>){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    phi_vec <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sapply</span>(phi, <span style=color:#a6e22e>function</span>(f, x){ <span style=color:#a6e22e>f</span>(x)}, x <span style=color:#f92672>=</span> x[t<span style=color:#ae81ff>-1</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    b[,t<span style=color:#ae81ff>-1</span>] <span style=color:#f92672>&lt;-</span> Z <span style=color:#f92672>%*%</span> (phi_vec<span style=color:#f92672>*</span>b[,t])
</span></span><span style=display:flex><span>    b[,t<span style=color:#ae81ff>-1</span>] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>pmax</span>(b[,t<span style=color:#ae81ff>-1</span>], <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>1e-15</span>,<span style=color:#ae81ff>1e-15</span>))
</span></span><span style=display:flex><span>    posterior[,t<span style=color:#ae81ff>-1</span>] <span style=color:#f92672>&lt;-</span> a[, t<span style=color:#ae81ff>-1</span>]<span style=color:#f92672>*</span>b[,t<span style=color:#ae81ff>-1</span>]
</span></span><span style=display:flex><span>    posterior[,t<span style=color:#ae81ff>-1</span>] <span style=color:#f92672>&lt;-</span> posterior[,t<span style=color:#ae81ff>-1</span>]<span style=color:#f92672>/</span><span style=color:#a6e22e>sum</span>(posterior[,t<span style=color:#ae81ff>-1</span>])
</span></span><span style=display:flex><span>    posterior<span style=color:#a6e22e>[is.nan</span>(posterior[, t<span style=color:#ae81ff>-1</span>]), t<span style=color:#ae81ff>-1</span>] <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>for</span>(i in <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>K){
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>for</span>(j in <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>K){
</span></span><span style=display:flex><span>        O[t<span style=color:#ae81ff>-1</span>,i,j] <span style=color:#f92672>&lt;-</span> a[i, t<span style=color:#ae81ff>-1</span>]<span style=color:#f92672>*</span>phi_vec[j]<span style=color:#f92672>*</span>b[j,t]<span style=color:#f92672>*</span>Z[i,j]
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    O[t<span style=color:#ae81ff>-1</span>,,] <span style=color:#f92672>&lt;-</span> O[t<span style=color:#ae81ff>-1</span>,,]<span style=color:#f92672>/</span><span style=color:#a6e22e>sum</span>(O[t<span style=color:#ae81ff>-1</span>,,])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>return</span>(<span style=color:#a6e22e>list</span>(posterior <span style=color:#f92672>=</span> <span style=color:#a6e22e>as.data.frame</span>(<span style=color:#a6e22e>t</span>(posterior)),
</span></span><span style=display:flex><span>              gamma <span style=color:#f92672>=</span> posterior,
</span></span><span style=display:flex><span>              O <span style=color:#f92672>=</span> O,
</span></span><span style=display:flex><span>              a <span style=color:#f92672>=</span> a
</span></span><span style=display:flex><span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>f_x1 <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>function</span>(x){<span style=color:#a6e22e>dnorm</span>(x, mean <span style=color:#f92672>=</span> <span style=color:#a6e22e>getpars</span>(hmmfit)[7], sd <span style=color:#f92672>=</span> <span style=color:#a6e22e>getpars</span>(hmmfit)[8])}
</span></span><span style=display:flex><span>f_x2 <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>function</span>(x){<span style=color:#a6e22e>dnorm</span>(x, mean <span style=color:#f92672>=</span> <span style=color:#a6e22e>getpars</span>(hmmfit)[9], sd <span style=color:#f92672>=</span> <span style=color:#a6e22e>getpars</span>(hmmfit)[10])}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>phi <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>list</span>(f_x1,f_x2)
</span></span><span style=display:flex><span>Z <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>matrix</span>(<span style=color:#a6e22e>getpars</span>(hmmfit)[3<span style=color:#f92672>:</span><span style=color:#ae81ff>6</span>], ncol <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>, byrow <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>)
</span></span><span style=display:flex><span>init_a <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fb_out <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>ForwardBackward</span>(init_a, Z, phi, returns)<span style=color:#f92672>$</span>posterior
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fb_out<span style=color:#f92672>$</span>days <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#a6e22e>length</span>(returns)
</span></span><span style=display:flex><span>fb_out<span style=color:#f92672>$</span>state <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>factor</span>(<span style=color:#a6e22e>ifelse</span>(fb_out<span style=color:#f92672>$</span>V1 <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0.5</span>, <span style=color:#e6db74>&#34;Bull&#34;</span>, <span style=color:#e6db74>&#34;Bear&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ggplot</span>(fb_out) <span style=color:#f92672>+</span> <span style=color:#a6e22e>geom_line</span>(<span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> days, y <span style=color:#f92672>=</span> V1, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Bear&#34;</span>)) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_line</span>(<span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> days, y <span style=color:#f92672>=</span> V2, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Bull&#34;</span>))<span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>theme_minimal</span>() <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>scale_color_manual</span>(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;State&#39;</span>,
</span></span><span style=display:flex><span>                     breaks<span style=color:#f92672>=</span><span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#39;Bear&#39;</span>, <span style=color:#e6db74>&#39;Bull&#39;</span>),
</span></span><span style=display:flex><span>                     values<span style=color:#f92672>=</span><span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#39;Bear&#39;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;red&#39;</span>, <span style=color:#e6db74>&#39;Bull&#39;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;darkgreen&#39;</span>))
</span></span></code></pre></div><p><img src=unnamed-chunk-8-1.png alt></p><p>By estimating the posterior using all observations via smoothing we can
see that we get more confident in our estimation. Instead of using the
forward-backward algorithm we can compute the most probable sequence of
states using the viterbi algorithm:
$$\boldsymbol{z}^{*} =\arg\max_{z_{1:T}} p(z_{1:T} | x_{1:T}) $$
</p><p>Note that the jointly most probable sequence of states (Viterbi) is not
necessarily the same as the sequence of marginally most probable states
(if we maximize forward-backwards).
$$\arg\max_{z_{1:T}} p(z_{1:T} | x_{1:T})\neq\Big(\arg\max_{z_1} p(z_1 | x_{1:T}),\dots, arg\max_{z_T} p(z_T | x_{1:T})\Big)$$
let’ define $m_t(j) =\max_{z_1,\dots, z_{t-1}} p(z_{1:t-1}, z_t = j | x_{1:t})$ and Note that we represent the most probable path by taking the maximum
over allpossible previous state sequences. Given that we had already
computed the probability of being in every state at time $t-1$
, we compute the Viterbi probability by taking the most probable of the
extensions of the paths that lead to the current cell:
$$m_t(j) =\max_{z_{t-1} = i} m_{t-1}(i) Z_{ij} p(x_t | z_t =j) $$
</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>viterbi <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>function</span>(init_a, Z, phi, x){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  best_state <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>matrix</span>(<span style=color:#ae81ff>0</span>, ncol <span style=color:#f92672>=</span> <span style=color:#a6e22e>length</span>(x), nrow <span style=color:#f92672>=</span> <span style=color:#a6e22e>length</span>(init_a))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  delta <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>matrix</span>(<span style=color:#ae81ff>0</span>, ncol <span style=color:#f92672>=</span> <span style=color:#a6e22e>length</span>(x), nrow <span style=color:#f92672>=</span> <span style=color:#a6e22e>length</span>(init_a))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  phi_vec <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sapply</span>(phi, <span style=color:#a6e22e>function</span>(f, x){ <span style=color:#a6e22e>f</span>(x)}, x <span style=color:#f92672>=</span> x[1])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  delta[,<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;-</span> init_a<span style=color:#f92672>*</span>phi_vec
</span></span><span style=display:flex><span>  delta[,<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;-</span> delta[,<span style=color:#ae81ff>1</span>]<span style=color:#f92672>/</span><span style=color:#a6e22e>sum</span>(delta[,<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>  delta<span style=color:#a6e22e>[is.nan</span>(delta[,<span style=color:#ae81ff>1</span>]),<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  best_state[1] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>which.max</span>(init_a)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Calculate most probable path to j</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>for</span>(i in <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span><span style=color:#a6e22e>length</span>(x)){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    phi_vec <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sapply</span>(phi, <span style=color:#a6e22e>function</span>(f, x){ <span style=color:#a6e22e>f</span>(x)}, x <span style=color:#f92672>=</span> x[i])
</span></span><span style=display:flex><span>    delta[,i] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sapply</span>(<span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#a6e22e>length</span>(init_a), <span style=color:#a6e22e>function</span>(x){<span style=color:#a6e22e>max</span>(delta[,i<span style=color:#ae81ff>-1</span>]<span style=color:#f92672>*</span>Z[,x]<span style=color:#f92672>*</span>phi_vec[x])})
</span></span><span style=display:flex><span>    delta[,i] <span style=color:#f92672>&lt;-</span> delta[,i]<span style=color:#f92672>/</span><span style=color:#a6e22e>sum</span>(delta[,i])
</span></span><span style=display:flex><span>    delta<span style=color:#a6e22e>[is.nan</span>(delta[,<span style=color:#ae81ff>1</span>]),<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    best_state[,i] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sapply</span>(<span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#a6e22e>length</span>(init_a), <span style=color:#a6e22e>function</span>(x){<span style=color:#a6e22e>which.max</span>(delta[,i<span style=color:#ae81ff>-1</span>]<span style=color:#f92672>*</span>Z[,x]<span style=color:#f92672>*</span>phi_vec[x])})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Compute most probable state using traceback.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  z <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>matrix</span>(<span style=color:#ae81ff>0</span>, ncol <span style=color:#f92672>=</span> <span style=color:#a6e22e>length</span>(x), nrow <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>  s <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>matrix</span>(<span style=color:#ae81ff>0</span>, ncol <span style=color:#f92672>=</span> <span style=color:#a6e22e>length</span>(x), nrow <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  z<span style=color:#a6e22e>[length</span>(x)] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>which.max</span>(delta[, <span style=color:#a6e22e>length</span>(x)])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>for</span>(i in <span style=color:#a6e22e>length</span>(x)<span style=color:#f92672>:</span><span style=color:#ae81ff>2</span>){
</span></span><span style=display:flex><span>    z[i<span style=color:#ae81ff>-1</span>] <span style=color:#f92672>&lt;-</span> best_state[z[i], i]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>return</span>(<span style=color:#a6e22e>list</span>(delta <span style=color:#f92672>=</span> delta, z <span style=color:#f92672>=</span> z, delta_df <span style=color:#f92672>=</span> <span style=color:#a6e22e>as.data.frame</span>(<span style=color:#a6e22e>t</span>(delta))))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>out_viterbi <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>viterbi</span>(init_a, Z, phi, returns)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>states <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>as.data.frame</span>(<span style=color:#a6e22e>t</span>(out_viterbi<span style=color:#f92672>$</span>z))
</span></span><span style=display:flex><span>states<span style=color:#f92672>$</span>time <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#a6e22e>nrow</span>(states)
</span></span><span style=display:flex><span>states<span style=color:#f92672>$</span>State <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>ifelse</span>(states<span style=color:#f92672>$</span>V1 <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;Bull&#34;</span>, <span style=color:#e6db74>&#34;Bear&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>ggplot</span>(states) <span style=color:#f92672>+</span> <span style=color:#a6e22e>geom_point</span>(<span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> time, y <span style=color:#f92672>=</span> V1, color <span style=color:#f92672>=</span> State)) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>scale_color_manual</span>(values<span style=color:#f92672>=</span><span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#39;Bear&#39;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;red&#39;</span>, <span style=color:#e6db74>&#39;Bull&#39;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;darkgreen&#39;</span>)) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>theme_minimal</span>()
</span></span></code></pre></div><p><img src=unnamed-chunk-9-1.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>out_viterbi<span style=color:#f92672>$</span>delta_df<span style=color:#f92672>$</span>days <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#a6e22e>nrow</span>(states)
</span></span><span style=display:flex><span><span style=color:#a6e22e>ggplot</span>(out_viterbi<span style=color:#f92672>$</span>delta_df) <span style=color:#f92672>+</span> <span style=color:#a6e22e>geom_line</span>(<span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> days, y <span style=color:#f92672>=</span> V1, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Bear&#34;</span>)) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_line</span>(<span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> days, y <span style=color:#f92672>=</span> V2, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Bull&#34;</span>))<span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>theme_minimal</span>() <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>scale_color_manual</span>(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;State&#39;</span>,
</span></span><span style=display:flex><span>                     breaks<span style=color:#f92672>=</span><span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#39;Bear&#39;</span>, <span style=color:#e6db74>&#39;Bull&#39;</span>),
</span></span><span style=display:flex><span>                     values<span style=color:#f92672>=</span><span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#39;Bear&#39;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;red&#39;</span>, <span style=color:#e6db74>&#39;Bull&#39;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;darkgreen&#39;</span>))
</span></span></code></pre></div><p><img src=unnamed-chunk-9-2.png alt></p><p>Finally, let’s write a function that estimates the HMM parameters and
compare it to the values of the <code>depmixs4</code> package. The Baum-Welch
algorithm, an Em algorithm for HMMs, is usually used. We are interested
in finding the parameters $\theta = (\mu_1,\mu_2,\sigma_1,\sigma_2,\boldsymbol{Z},\pi)$ where $\mu_k,\sigma_k$ is the mean and standard deviation of the returns in state $k$. To make it a bit more generalized, let $K$ be the number of states. In the E-step we calculate the expected value
using $p(\boldsymbol{z}|\boldsymbol{x},\theta)$</p><p>$$
\begin{aligned}
Q(\theta,\theta^{old}) &= E_{\boldsymbol{z}|\boldsymbol{x},\theta^{old}}[\log p(\boldsymbol{z},\boldsymbol{x} |\theta)]\\\
&= E_{\boldsymbol{z}|\boldsymbol{x},\theta^{old}}[\log p(z_1 |\theta)\prod_{t = 2}^T\log p(z_t | z_{t-1},\theta)\prod_{t = 1}^T\log p(x_t | z_{t},\theta)]\\\
&=\sum_{i = 1}^K p(z_1 = i |\boldsymbol{x},\theta^{old})\log\pi_i\\\
& +\sum_{t = 1}^T\sum_{i = 1}^K\sum_{j = 1}^K p(z_{t-1} = j,z_t = i|\boldsymbol{x},\theta^{old})\log p(Z_{ji} |\theta)\\\
& +\sum_{t = 1}^T\sum_{i = 1}^K p(z_{t} = i|\boldsymbol{x},\theta^{old})\log p(x_t | z_{t},\theta)]\\\
\end{aligned}
$$</p><p>Next we perform the M-step and we maximize $Q$ with respect to theta. The constraints are $\sum_i^K Z_{ji} = 1$ for all $j = 1,\dots, K$ and $\sum_i\pi_i = 1$
. The Lagrangian of the objective is:</p><p>$$
\begin{aligned}
\arg\max_\theta Q(\theta) + \lambda(\sum_i \pi_i - 1) + \eta_j (\sum_i^K Z_{ji} -1)
\end{aligned}
$$</p><p>Taking derivative w.r.t to $\pi_i = p(z_1 = i |\boldsymbol{x},\theta^{old})/\lambda$, and using the fact that $\sum_i pi_1 =1$ we get $\lambda = 1$, with similar argument we get that
$Z_{ji} = \frac{N_{ji}}{\sum_k N_{jk}}$ where $N_{ji} =\sum_{t = 2}^T p(z_{t-1} = j,z_t = i|\boldsymbol{x},\theta^{old})$. Because in this case we are assuming that $p(x_t | z_t,\theta)$ is a normal distribution we get:</p><p>$$
\begin{equation}
\mu_k =\frac{\sum_t^T\gamma_t(k) x_t}{\sum_t^T\gamma_t(k)},\quad,\sigma^2 =\frac{\sum_t^T\gamma_t(k)x_t^2 - N_j\mu^2}{N_j}
\end{equation}
$$</p><p>where $N_j =\sum_t^T p(z_{t} = j|\boldsymbol{x},\theta^{old})$
. With the equations at hand we write a function for the EM.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>EM <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>function</span>(x, k, nr_itr <span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span>){
</span></span><span style=display:flex><span>  <span style=color:#75715e># x - data</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># k - number of states</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># nr_itr - number of EM iterations</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Z <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>matrix</span>(<span style=color:#a6e22e>rep</span>(<span style=color:#ae81ff>1</span>,k^2)<span style=color:#f92672>/</span>k, nrow <span style=color:#f92672>=</span> k, ncol <span style=color:#f92672>=</span> k)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  means <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rnorm</span>(k)
</span></span><span style=display:flex><span>  sds <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>  init_a <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rep</span>(<span style=color:#ae81ff>1</span>, k)<span style=color:#f92672>/</span>k
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>for</span>(n in <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>nr_itr){
</span></span><span style=display:flex><span>    density <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>lapply</span>(<span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>k, <span style=color:#a6e22e>function</span>(i){<span style=color:#a6e22e>function</span>(x){<span style=color:#a6e22e>dnorm</span>(x, mean <span style=color:#f92672>=</span> means[i], sd <span style=color:#f92672>=</span> sds[i])}})
</span></span><span style=display:flex><span>    fb_out <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>ForwardBackward</span>(init_a, Z, density, x)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>for</span>(i in <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>k){
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>for</span>(j in <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>k){
</span></span><span style=display:flex><span>        Z[i,j] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sum</span>(fb_out<span style=color:#f92672>$</span>O[,i,j])<span style=color:#f92672>/</span><span style=color:#a6e22e>sum</span>(fb_out<span style=color:#f92672>$</span>O[,i,])
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>for</span>(i in <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>k){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      init_a[i] <span style=color:#f92672>&lt;-</span> fb_out<span style=color:#f92672>$</span>gamma[i,<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>for</span>(i in <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>k){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      means[i] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sum</span>(fb_out<span style=color:#f92672>$</span>gamma[i,]<span style=color:#f92672>*</span>x)<span style=color:#f92672>/</span><span style=color:#a6e22e>sum</span>(fb_out<span style=color:#f92672>$</span>gamma[i,])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      sds[i] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sqrt</span>((<span style=color:#a6e22e>sum</span>(fb_out<span style=color:#f92672>$</span>gamma[i,]<span style=color:#f92672>*</span>x^2) <span style=color:#f92672>-</span> <span style=color:#a6e22e>sum</span>(fb_out<span style=color:#f92672>$</span>gamma[i,])<span style=color:#f92672>*</span>means[i]^2)<span style=color:#f92672>/</span> <span style=color:#a6e22e>sum</span>(fb_out<span style=color:#f92672>$</span>gamma[i,]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>return</span>(<span style=color:#a6e22e>list</span>(means <span style=color:#f92672>=</span> means, sds <span style=color:#f92672>=</span> sds, Z <span style=color:#f92672>=</span> Z, init_a <span style=color:#f92672>=</span> init_a, fb_out <span style=color:#f92672>=</span> fb_out))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>out_em <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>EM</span>(returns, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>print</span>(out_em<span style=color:#f92672>$</span>means)
</span></span></code></pre></div><pre><code>## [1]  0.09608514 -0.08617614
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>print</span>(out_em<span style=color:#f92672>$</span>sds)
</span></span></code></pre></div><pre><code>## [1] 0.1015317 0.2170290
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>print</span>(out_em<span style=color:#f92672>$</span>Z)
</span></span></code></pre></div><pre><code>##            [,1]        [,2]
## [1,] 0.99597796 0.004022039
## [2,] 0.00416305 0.995836950
</code></pre><p>Comparing to the depmaxs4 package</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>getpars</span>(hmmfit)
</span></span></code></pre></div><pre><code>##          pr1          pr2                                                      (Intercept)           sd  (Intercept)           sd
##  0.000000000  1.000000000  0.990073371  0.009926629  0.006200274  0.993799726 -0.084785623  0.217380580  0.094950502  0.103102669
</code></pre><p>We get very similar results, but both estimates are somewhat off the real parameters. Finally we can plot the posterior
probability of the states. The</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>posterior <span style=color:#f92672>&lt;-</span> out_em<span style=color:#f92672>$</span>fb_out<span style=color:#f92672>$</span>posterior
</span></span><span style=display:flex><span>posterior<span style=color:#f92672>$</span>days <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#a6e22e>length</span>(returns)
</span></span><span style=display:flex><span>posterior<span style=color:#f92672>$</span>state <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>factor</span>(<span style=color:#a6e22e>ifelse</span>(posterior<span style=color:#f92672>$</span>V1 <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0.5</span>, <span style=color:#e6db74>&#34;Bull&#34;</span>, <span style=color:#e6db74>&#34;Bear&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ggplot</span>(posterior) <span style=color:#f92672>+</span> <span style=color:#a6e22e>geom_line</span>(<span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> days, y <span style=color:#f92672>=</span> V1, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Bear&#34;</span>)) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_line</span>(<span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> days, y <span style=color:#f92672>=</span> V2, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Bull&#34;</span>))<span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>theme_minimal</span>() <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>scale_color_manual</span>(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;State&#39;</span>,
</span></span><span style=display:flex><span>                     breaks<span style=color:#f92672>=</span><span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#39;Bear&#39;</span>, <span style=color:#e6db74>&#39;Bull&#39;</span>),
</span></span><span style=display:flex><span>                     values<span style=color:#f92672>=</span><span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#39;Bear&#39;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;red&#39;</span>, <span style=color:#e6db74>&#39;Bull&#39;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;darkgreen&#39;</span>))
</span></span></code></pre></div><p><img src=unnamed-chunk-12-1.png alt></p></div></div></div><div class="layui-col-md4 layui-col-sm12 layui-col-xs12">
<div class="layui-card single-card">
<h2 class=single-title>Relevant Topics</h2><div style=margin-left:10px>
<blockquote class="self-elem-quote self-elem-quote-bg-red" style=background-color:#fff;margin-top:10px>
<a href=/post/deepkernel/>
<h3>Deep Graph Kernels</h3></a>
<h3 style=margin-top:10px;margin-bottom:10px>
<i class="layui-icon layui-icon-date" style=font-size:28px;vertical-align:-2px></i>
<span>2021-11-16</span>
<i class="layui-icon layui-icon-tabs" style=font-size:22px;vertical-align:1px;margin-right:2px></i>
<a href=/tags/graph/>
<span class="layui-badge layui-bg-orange" style=vertical-align:2px>Graph</span>
</a>
<a href=/tags/classification/>
<span class="layui-badge layui-bg-orange" style=vertical-align:2px>Classification</span>
</a>
<a href=/tags/kernel/>
<span class="layui-badge layui-bg-orange" style=vertical-align:2px>Kernel</span>
</a>
</h3></blockquote></div><br>
</div><div class="layui-card single-card">
<h2 class=single-title>Recent Posts</h2><div style=margin-left:10px>
<blockquote class="self-elem-quote self-elem-quote-bg-red" style=background-color:#fff;margin-top:10px>
<a href=/post/glm/>
<h3>Generalized Lienar Models</h3></a>
<h3 style=margin-top:10px;margin-bottom:10px>
<i class="layui-icon layui-icon-date" style=font-size:28px;vertical-align:-2px></i>
<span>2022-03-02</span>
<i class="layui-icon layui-icon-tabs" style=font-size:22px;vertical-align:1px;margin-right:2px></i>
<a href=/tags/model/>
<span class="layui-badge layui-bg-orange" style=vertical-align:2px>Model</span>
</a>
</h3></blockquote></div><div style=margin-left:10px>
<blockquote class="self-elem-quote self-elem-quote-bg-red" style=background-color:#fff;margin-top:10px>
<a href=/post/hmm/>
<h3>Hidden Markov Models</h3></a>
<h3 style=margin-top:10px;margin-bottom:10px>
<i class="layui-icon layui-icon-date" style=font-size:28px;vertical-align:-2px></i>
<span>2022-02-15</span>
<i class="layui-icon layui-icon-tabs" style=font-size:22px;vertical-align:1px;margin-right:2px></i>
<a href=/tags/model/>
<span class="layui-badge layui-bg-orange" style=vertical-align:2px>Model</span>
</a>
<a href=/tags/classification/>
<span class="layui-badge layui-bg-orange" style=vertical-align:2px>Classification</span>
</a>
</h3></blockquote></div><div style=margin-left:10px>
<blockquote class="self-elem-quote self-elem-quote-bg-red" style=background-color:#fff;margin-top:10px>
<a href=/post/extremes/>
<h3>Quntitative Risk Analysis</h3></a>
<h3 style=margin-top:10px;margin-bottom:10px>
<i class="layui-icon layui-icon-date" style=font-size:28px;vertical-align:-2px></i>
<span>2021-11-17</span>
<i class="layui-icon layui-icon-tabs" style=font-size:22px;vertical-align:1px;margin-right:2px></i>
<a href=/tags/risk/>
<span class="layui-badge layui-bg-orange" style=vertical-align:2px>Risk</span>
</a>
<a href=/tags/extremes/>
<span class="layui-badge layui-bg-orange" style=vertical-align:2px>Extremes</span>
</a>
</h3></blockquote></div><div style=margin-left:10px>
<blockquote class="self-elem-quote self-elem-quote-bg-red" style=background-color:#fff;margin-top:10px>
<a href=/post/deepkernel/>
<h3>Deep Graph Kernels</h3></a>
<h3 style=margin-top:10px;margin-bottom:10px>
<i class="layui-icon layui-icon-date" style=font-size:28px;vertical-align:-2px></i>
<span>2021-11-16</span>
<i class="layui-icon layui-icon-tabs" style=font-size:22px;vertical-align:1px;margin-right:2px></i>
<a href=/tags/graph/>
<span class="layui-badge layui-bg-orange" style=vertical-align:2px>Graph</span>
</a>
<a href=/tags/classification/>
<span class="layui-badge layui-bg-orange" style=vertical-align:2px>Classification</span>
</a>
<a href=/tags/kernel/>
<span class="layui-badge layui-bg-orange" style=vertical-align:2px>Kernel</span>
</a>
</h3></blockquote></div><div style=margin-left:10px>
<blockquote class="self-elem-quote self-elem-quote-bg-red" style=background-color:#fff;margin-top:10px>
<a href=/post/correlationnetwork/>
<h3>Group Identification in Stock Markets</h3></a>
<h3 style=margin-top:10px;margin-bottom:10px>
<i class="layui-icon layui-icon-date" style=font-size:28px;vertical-align:-2px></i>
<span>2021-09-16</span>
<i class="layui-icon layui-icon-tabs" style=font-size:22px;vertical-align:1px;margin-right:2px></i>
<a href=/tags/risk/>
<span class="layui-badge layui-bg-orange" style=vertical-align:2px>Risk</span>
</a>
</h3></blockquote></div><br>
</div></div></div></div></div><footer>
<div class=layui-container>
<p class=copyright>&copy; All rights reserved. Powered by <a href=https://gohugo.io style=color:#fff>Hugo</a>, <a href=https://github.com/ertuil/erblog style=color:#fff>Erblog</a> and <a href=https://github.com/vlunot/nb2hugo style=color:#fff>nb2hugo</a>.</p></div></footer></body></html>